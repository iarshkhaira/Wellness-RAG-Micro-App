/************************************************
 * Wellness RAG Micro-App
 * Ask Me Anything About Yoga
 *
 * Tech Stack:
 * - Node.js + Express
 * - MongoDB (Mongoose)
 * - Retrieval-Augmented Generation (RAG)
 * - Safety Guardrails for Health Queries
 *
 * Author: Kunal Singh
 ************************************************/

import express from "express";
import mongoose from "mongoose";
import cors from "cors";
import bodyParser from "body-parser";
import dotenv from "dotenv";
import OpenAI from "openai";

dotenv.config();

/* -------------------- APP SETUP -------------------- */
const app = express();
app.use(cors());
app.use(bodyParser.json());

/* -------------------- OPENAI SETUP -------------------- */
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

/* -------------------- MONGODB CONNECTION -------------------- */
mongoose
  .connect(process.env.MONGODB_URI)
  .then(() => console.log("âœ… MongoDB connected"))
  .catch((err) => console.error("âŒ MongoDB error:", err));

const QuerySchema = new mongoose.Schema({
  query: String,
  retrievedChunks: [String],
  answer: String,
  isUnsafe: Boolean,
  feedback: Boolean,
  createdAt: { type: Date, default: Date.now },
});

const QueryLog = mongoose.model("QueryLog", QuerySchema);

/* -------------------- YOGA KNOWLEDGE BASE -------------------- */
/* Expand this list to 20â€“50 entries if required */

const yogaDocs = [
  {
    id: "A1",
    title: "Benefits of Shavasana",
    content:
      "Shavasana helps reduce stress, relax the nervous system, and improve mindfulness. It is suitable for all levels.",
  },
  {
    id: "A2",
    title: "Contraindications of Headstand",
    content:
      "Headstand should be avoided by people with neck injuries, glaucoma, high blood pressure, or during pregnancy.",
  },
  {
    id: "A3",
    title: "Pranayama for Beginners",
    content:
      "Breathing practices like Anulom Vilom help calm the mind and improve lung capacity.",
  },
];

/* -------------------- SIMPLE EMBEDDING & SIMILARITY -------------------- */
/* Lightweight RAG for clarity and easy evaluation */

function embed(text) {
  const words = text.toLowerCase().split(/\W+/);
  const vector = {};
  words.forEach((w) => {
    if (!w) return;
    vector[w] = (vector[w] || 0) + 1;
  });
  return vector;
}

function similarity(vec1, vec2) {
  let dot = 0,
    normA = 0,
    normB = 0;

  for (let k in vec1) {
    dot += (vec1[k] || 0) * (vec2[k] || 0);
    normA += vec1[k] ** 2;
  }
  for (let k in vec2) normB += vec2[k] ** 2;

  return dot / (Math.sqrt(normA) * Math.sqrt(normB) || 1);
}

/* Pre-embed documents */
const embeddedDocs = yogaDocs.map((doc) => ({
  ...doc,
  embedding: embed(doc.content),
}));

/* -------------------- SAFETY FILTER -------------------- */
const unsafeKeywords = [
  "pregnant",
  "pregnancy",
  "hernia",
  "glaucoma",
  "high blood pressure",
  "surgery",
  "heart",
];

function isUnsafeQuery(query) {
  return unsafeKeywords.some((k) =>
    query.toLowerCase().includes(k)
  );
}

/* -------------------- ASK API -------------------- */
app.post("/ask", async (req, res) => {
  try {
    const { query } = req.body;
    if (!query) {
      return res.status(400).json({ error: "Query is required" });
    }

    const unsafe = isUnsafeQuery(query);

    /* Retrieve top 3 relevant chunks */
    const qEmbedding = embed(query);
    const scoredDocs = embeddedDocs
      .map((doc) => ({
        ...doc,
        score: similarity(qEmbedding, doc.embedding),
      }))
      .sort((a, b) => b.score - a.score)
      .slice(0, 3);

    const context = scoredDocs.map((d) => d.content).join("\n");

    let answer;

    if (unsafe) {
      answer = `âš ï¸ Safety Notice:
Your question involves a condition where yoga practices may be risky.

Consider gentle breathing or relaxation practices.
Please consult a doctor or certified yoga therapist before practicing.`;
    } else {
      const completion = await openai.chat.completions.create({
        model: "gpt-4o-mini",
        messages: [
          {
            role: "system",
            content:
              "You are a yoga assistant. Answer ONLY using the provided context.",
          },
          {
            role: "user",
            content: `Context:\n${context}\n\nQuestion:\n${query}`,
          },
        ],
      });

      answer = completion.choices[0].message.content;
    }

    /* Save interaction to MongoDB */
    const log = await QueryLog.create({
      query,
      retrievedChunks: scoredDocs.map((d) => d.title),
      answer,
      isUnsafe: unsafe,
    });

    res.json({
      answer,
      sources: scoredDocs.map(
        (d, i) => `Source ${i + 1}: ${d.title}`
      ),
      isUnsafe: unsafe,
      queryId: log._id,
    });
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: "Internal server error" });
  }
});

/* -------------------- FEEDBACK API -------------------- */
app.post("/feedback", async (req, res) => {
  const { queryId, helpful } = req.body;
  await QueryLog.findByIdAndUpdate(queryId, {
    feedback: helpful,
  });
  res.json({ message: "Feedback recorded" });
});

/* -------------------- SERVER -------------------- */
const PORT = process.env.PORT || 5000;
app.listen(PORT, () => {
  console.log(`ðŸ§˜ Yoga RAG Server running on port ${PORT}`);
});
